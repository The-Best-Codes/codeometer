#!/bin/bash

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
RESET='\033[0m'

# Default settings
USE_COLORS=true
USE_FORMATTING=true

# Parse command line arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
    --no-color) USE_COLORS=false ;;
    --no-format) USE_FORMATTING=false ;;
    *) PROJECT_DIR="$1" ;;
    esac
    shift
done

# Function to apply color if colors are enabled
apply_color() {
    if $USE_COLORS; then
        echo -ne "${!1}"
    fi
}

# Function to reset color if colors are enabled
reset_color() {
    if $USE_COLORS; then
        echo -ne "${RESET}"
    fi
}

# Function to get terminal width
get_terminal_width() {
    if $USE_FORMATTING; then
        tput cols 2>/dev/null || echo 80
    else
        echo 80
    fi
}

# Function to print centered text
print_centered() {
    if $USE_FORMATTING; then
        local text="$1"
        local width=$(get_terminal_width)
        local padding=$(((width - ${#text}) / 2))
        printf "%${padding}s%s%${padding}s\n" "" "$text" ""
    else
        echo "$1"
    fi
}

# Function to print a horizontal line
print_line() {
    if $USE_FORMATTING; then
        local width=$(get_terminal_width)
        printf '%*s\n' "$width" | tr ' ' '-'
    fi
}

# Check if a directory path is provided
if [ -z "$PROJECT_DIR" ]; then
    apply_color "RED"
    echo "Error: Please provide the path to your code project."
    reset_color
    echo "Usage: codeometer [--no-color] [--no-format] /path/to/your/project"
    exit 1
fi

# Check if the directory exists
if [ ! -d "$PROJECT_DIR" ]; then
    apply_color "RED"
    echo "Error: Directory does not exist."
    reset_color
    exit 1
fi

# Function to count lines and files
count_lines_and_files() {
    find "$1" -type f \( -name "*.$2" \) -print0 | wc -l --files0-from=- 2>/dev/null | awk '
        NF==2 {files++; lines+=$1}
        END {print lines, files}'
}

# Function to detect project type
detect_project_type() {
    if [ -f "$PROJECT_DIR/package.json" ]; then
        echo "Node.js"
    elif [ -f "$PROJECT_DIR/requirements.txt" ] || [ -f "$PROJECT_DIR/setup.py" ]; then
        echo "Python"
    elif [ -f "$PROJECT_DIR/pom.xml" ] || [ -f "$PROJECT_DIR/build.gradle" ]; then
        echo "Java"
    elif [ -f "$PROJECT_DIR/Cargo.toml" ]; then
        echo "Rust"
    elif [ -f "$PROJECT_DIR/go.mod" ]; then
        echo "Go"
    elif [ -f "$PROJECT_DIR/Gemfile" ]; then
        echo "Ruby"
    elif [ -f "$PROJECT_DIR/composer.json" ]; then
        echo "PHP"
    elif [ -f "$PROJECT_DIR/CMakeLists.txt" ]; then
        echo "C/C++"
    elif [ -d "$PROJECT_DIR/.git" ]; then
        echo "Git (Unable to determine specific language)"
    else
        echo "Unknown"
    fi
}

# Function to display progress bar
display_progress() {
    if $USE_FORMATTING; then
        local current=$1
        local total=$2
        local width=$(($(get_terminal_width) - 20))
        local percentage=$((current * 100 / total))
        local filled=$((width * current / total))
        local empty=$((width - filled))

        apply_color "CYAN"
        printf "\rProgress: ["
        apply_color "GREEN"
        printf '%*s' "$filled" | tr ' ' '#'
        apply_color "CYAN"
        printf '%*s' "$empty" | tr ' ' '-'
        printf "] %3d%%" "$percentage"
        reset_color
    fi
}

# Detect project type
PROJECT_TYPE=$(detect_project_type)

# Set auto-generated directories and file types based on project type
case $PROJECT_TYPE in
"Node.js")
    AUTO_GEN_DIRS="node_modules"
    FILE_TYPES="js jsx ts tsx json"
    ;;
"Python")
    AUTO_GEN_DIRS="venv env .venv"
    FILE_TYPES="py pyw pyx pxd pxi"
    ;;
"Java")
    AUTO_GEN_DIRS="target build"
    FILE_TYPES="java class jar"
    ;;
"Rust")
    AUTO_GEN_DIRS="target"
    FILE_TYPES="rs toml"
    ;;
"Go")
    AUTO_GEN_DIRS="vendor"
    FILE_TYPES="go"
    ;;
"Ruby")
    AUTO_GEN_DIRS="vendor"
    FILE_TYPES="rb rake"
    ;;
"PHP")
    AUTO_GEN_DIRS="vendor"
    FILE_TYPES="php phtml php3 php4 php5 php7 phps"
    ;;
"C/C++")
    AUTO_GEN_DIRS="build"
    FILE_TYPES="c cpp cxx cc h hpp hxx hh"
    ;;
*)
    AUTO_GEN_DIRS=""
    FILE_TYPES="py js jsx ts tsx html css java cpp c h rb php go rs"
    apply_color "YELLOW"
    echo "Warning: Unable to determine specific project type. Counting all common file types."
    reset_color
    ;;
esac

# Initialize variables
TOTAL_LINES=0
TOTAL_FILES=0
AUTO_GENERATED_LINES=0
AUTO_GENERATED_FILES=0

# Count total lines and files
total_extensions=$(echo $FILE_TYPES | wc -w)
current_extension=0

for ext in $FILE_TYPES; do
    current_extension=$((current_extension + 1))
    read -r lines files <<<$(count_lines_and_files "$PROJECT_DIR" "$ext")
    TOTAL_LINES=$((TOTAL_LINES + lines))
    TOTAL_FILES=$((TOTAL_FILES + files))
    display_progress $current_extension $total_extensions
done

echo "" # Move to the next line after the progress bar

# Count auto-generated lines and files
for dir in $AUTO_GEN_DIRS; do
    if [ -d "$PROJECT_DIR/$dir" ]; then
        for ext in $FILE_TYPES; do
            read -r lines files <<<$(count_lines_and_files "$PROJECT_DIR/$dir" "$ext")
            AUTO_GENERATED_LINES=$((AUTO_GENERATED_LINES + lines))
            AUTO_GENERATED_FILES=$((AUTO_GENERATED_FILES + files))
        done
    fi
done

# Calculate hand-written lines and files
HAND_WRITTEN_LINES=$((TOTAL_LINES - AUTO_GENERATED_LINES))
HAND_WRITTEN_FILES=$((TOTAL_FILES - AUTO_GENERATED_FILES))

# Function to print formatted output
print_stat() {
    local category="$1"
    local lines="$2"
    local files="$3"

    if $USE_FORMATTING; then
        apply_color "MAGENTA"
        printf "%-20s" "$category"
        reset_color
        apply_color "YELLOW"
        printf "%8d" "$lines"
        reset_color
        apply_color "GREEN"
        printf "%8d\n" "$files"
        reset_color
    else
        echo "$category: $lines lines, $files files"
    fi
}

# Print statistics
if $USE_FORMATTING; then
    print_line
    apply_color "BLUE"
    print_centered "Project Analysis Report"
    reset_color
    print_line
fi

apply_color "CYAN"
echo "Project Type: $PROJECT_TYPE"
reset_color
echo ""

apply_color "BLUE"
echo "Code Statistics:"
reset_color

if $USE_FORMATTING; then
    print_line
    apply_color "MAGENTA"
    printf "%-20s" "Category"
    apply_color "YELLOW"
    printf "%8s" "Lines"
    apply_color "GREEN"
    printf "%8s\n" "Files"
    reset_color
    print_line
fi

print_stat "Total:" "$TOTAL_LINES" "$TOTAL_FILES"
print_stat "Hand-written:" "$HAND_WRITTEN_LINES" "$HAND_WRITTEN_FILES"
print_stat "Auto-generated:" "$AUTO_GENERATED_LINES" "$AUTO_GENERATED_FILES"

if $USE_FORMATTING; then
    print_line
fi

# Calculate and print percentages
if [ $TOTAL_LINES -ne 0 ]; then
    HAND_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($HAND_WRITTEN_LINES / $TOTAL_LINES) * 100}")
    AUTO_PERCENT=$(awk "BEGIN {printf \"%.2f\", ($AUTO_GENERATED_LINES / $TOTAL_LINES) * 100}")
else
    HAND_PERCENT="0.00"
    AUTO_PERCENT="0.00"
fi

echo ""
apply_color "BLUE"
echo "Percentages:"
reset_color
apply_color "CYAN"
echo "  Hand-written:"
reset_color
apply_color "YELLOW"
echo "    $HAND_PERCENT%"
reset_color
apply_color "CYAN"
echo "  Auto-generated:"
reset_color
apply_color "YELLOW"
echo "    $AUTO_PERCENT%"
reset_color

# Print lines by file extension
echo ""
apply_color "BLUE"
echo "Lines of code by file extension:"
reset_color
for ext in $FILE_TYPES; do
    read -r lines files <<<$(count_lines_and_files "$PROJECT_DIR" "$ext")
    if [ "$lines" != "0" ]; then
        apply_color "CYAN"
        printf "  %-5s:" ".$ext"
        reset_color
        apply_color "YELLOW"
        printf "%8d" "$lines"
        reset_color
        echo " lines in $files files"
    fi
done

if $USE_FORMATTING; then
    print_line
fi
